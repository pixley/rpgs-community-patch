name: Release RPG Sounds Community Patch

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Input tag for release'
        required: true
        type: string

jobs:
  build:
    runs-on: windows-2019

    steps:
      - uses: actions/checkout@v4
        with:
            lfs: 'true'

      - name: Suppress install script
        run: echo "install script suppressor!" > suppress-install-ps1.txt

      - name: Get FMOD library from private repo
        env:
          TOKEN: ${{ secrets.FMOD_LIB_REPO }}
        run: |
          mkdir .\fmod_win32_mf\lib

          $json_response = curl -L `
            -H "Accept: application/vnd.github.raw+json" `
            -H "Authorization: Bearer ${TOKEN}" `
            -H "X-GitHub-Api-Version: 2022-11-28" `
            https://api.github.com/repos/pixley/fmod-lib-for-rpgs-patch/contents/fmod_vc.lib
          $response_object = ConvertFrom-Json -InputObject $json_response
          echo {[Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($response_object.content))} > .\fmod_win32_mf\lib\fmod_vc.lib

          echo "Download successful?" (Test-Path -Path .\fmod_win32_mf\lib\fmod_vc.lib -PathType leaf)

      - name: Build Mod
        run: |
          & "C:/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/Common7/IDE/devenv.com" rpgs-patch.sln /Rebuild "Release|x64"

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{github.event_name == 'push' && github.ref_name || inputs.tag}}"

          gh release create "$tag" `
            --title="$tag" `
            --draft `
            Info.json .\bin\Release\fmod_win32_mf.dll .\bin\Release\rpgs-patch.dll readme.md license.txt
